<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Verify Email - Gcash</title>
  <link rel="stylesheet" href="css/style.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    /* Custom styles specifically for verification page - matches your GCash theme */
    .verification-container {
      max-width: 400px;
      margin: 40px auto;
      background: #0066cc;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .verification-header {
      background-color: #0066cc;
      color: white;
      padding: 30px 20px;
      text-align: center;
    }

    .verification-header h2 {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 8px;
    }

    .verification-header p {
      font-size: 15px;
      opacity: 0.9;
    }

    .verification-body {
      padding: 30px 25px;
      text-align: center;
    }

    .otp-inputs {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 25px 0;
    }

    .otp-input {
      width: 50px;
      height: 60px;
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      transition: all 0.3s;
    }

    .otp-input:focus {
      outline: none;
      border-color: #0066cc;
      box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.2);
    }

    .verify-btn {
      width: 100%;
      padding: 16px;
      background-color: #0066cc;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 17px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
      transition: background-color 0.3s;
    }

    .verify-btn:hover:not(:disabled) {
      background-color: #004c99;
    }

    .verify-btn:disabled {
      background-color: #767676;
      cursor: not-allowed;
    }

    .resend-text {
      margin-top: 20px;
      font-size: 14px;
      color: var(--gcash-gray);
    }

    .resend-link {
      color: #0066cc;
      font-weight: bold;
      text-decoration: none;
    }

    .resend-link:hover {
      text-decoration: underline;
    }

    .countdown-timer {
      margin-top: 15px;
      font-size: 14px;
      color: var(--gcash-gray);
    }

    .expired-text {
      color: var(--gcash-red) !important;
      font-weight: bold;
    }
  </style>
</head>
<body class="bg-gray-100">

  <div class="verification-container">
    <div class="verification-header">
      <h2>Verify Your Email</h2>
      <p>We've sent a 6-digit code to<br><strong><%= email %></strong></p>
    </div>

    <div class="verification-body">
      <form id="verify-form">
        <div class="otp-inputs">
          <% for(let i = 0; i < 6; i++) { %>
            <input
              type="text"
              maxlength="1"
              class="otp-input"
              inputmode="numeric"
              autocomplete="one-time-code"
              required
            />
          <% } %>
        </div>

        <button type="submit" id="verify-btn" class="verify-btn">
          Verify Account
        </button>
      </form>

      <div class="resend-text">
        Didn't receive the code? 
        <a href="#" id="resend-link" class="resend-link">Resend</a>
      </div>

      <div id="countdown" class="countdown-timer">
        Code expires in 15:00
      </div>
    </div>
  </div>

  <script>
  const inputs = document.querySelectorAll('.otp-input');
  const form = document.getElementById('verify-form');
  const verifyBtn = document.getElementById('verify-btn');
  const resendLink = document.getElementById('resend-link');
  const countdownEl = document.getElementById('countdown');

  // Auto-focus next input + FIX: Allow typing in the last box
  inputs.forEach((input, index) => {
    input.addEventListener('input', (e) => {
      const value = e.target.value;

      // Only allow single digit (0-9)
      if (/^\d$/.test(value)) {
        e.target.value = value; // Keep the digit

        // Move to next input if not the last one
        if (index < 5) {
          inputs[index + 1].focus();
        }
      } else {
        // Clear invalid input (letters, multiple digits, symbols)
        e.target.value = '';
      }
    });

    // Handle backspace to go to previous field
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Backspace' && input.value === '' && index > 0) {
        inputs[index - 1].focus();
      }
    });

    // Optional: Allow pasting full 6-digit code
    input.addEventListener('paste', (e) => {
      e.preventDefault();
      const paste = (e.clipboardData || window.clipboardData).getData('text');
      const digits = paste.replace(/\D/g, '').slice(0, 6);

      if (digits.length > 0) {
        digits.split('').forEach((digit, i) => {
          if (inputs[i]) {
            inputs[i].value = digit;
          }
        });
        // Focus the last filled or next empty
        const nextEmpty = inputs[digits.length] || inputs[5];
        nextEmpty.focus();
      }
    });
  });

  // Countdown Timer (15 minutes)
  let timeLeft = 900;
  const timer = setInterval(() => {
    if (timeLeft <= 0) {
      clearInterval(timer);
      countdownEl.innerHTML = '<span class="expired-text">Code expired. Please request a new one.</span>';
      resendLink.style.display = 'inline';
      return;
    }
    const mins = Math.floor(timeLeft / 60).toString().padStart(2, '0');
    const secs = (timeLeft % 60).toString().padStart(2, '0');
    countdownEl.textContent = `Code expires in ${mins}:${secs}`;
    timeLeft--;
  }, 1000);

  // Submit verification
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const code = Array.from(inputs).map(i => i.value).join('');

    if (code.length !== 6 || !/^\d{6}$/.test(code)) {
      Swal.fire('Invalid Code', 'Please enter all 6 digits', 'error');
      return;
    }

    verifyBtn.textContent = 'Verifying...';
    verifyBtn.disabled = true;

    try {
      const res = await fetch('/api/verify-email', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token: code })
      });

      const data = await res.json();

      if (data.success) {
        Swal.fire({
          icon: 'success',
          title: 'Verified!',
          text: 'Your email has been verified successfully.',
          timer: 2000,
          showConfirmButton: false
        }).then(() => {
          window.location.href = '/dashboard';
        });
      } else {
        Swal.fire('Invalid Code', data.message || 'The code is incorrect or expired', 'error');
        inputs.forEach(input => input.value = '');
        inputs[0].focus();
      }
    } catch (err) {
      Swal.fire('Error', 'Something went wrong. Please try again.', 'error');
    } finally {
      verifyBtn.textContent = 'Verify Account';
      verifyBtn.disabled = false;
    }
  });

  // Resend code
  resendLink.addEventListener('click', async (e) => {
    e.preventDefault();
    resendLink.textContent = 'Sending...';
    resendLink.style.pointerEvents = 'none';

    try {
      const res = await fetch('/api/resend-verification', { method: 'POST' });
      const data = await res.json();

      if (data.success) {
        timeLeft = 900;
        inputs.forEach(input => input.value = '');
        inputs[0].focus();
        Swal.fire('Sent!', 'A new code has been sent to your email.', 'success');
      } else {
        Swal.fire('Failed', data.message || 'Could not resend code', 'error');
      }
    } catch (err) {
      Swal.fire('Error', 'Network error. Please try again.', 'error');
    } finally {
      resendLink.textContent = 'Resend';
      resendLink.style.pointerEvents = 'auto';
    }
  });
</script>
 
</body>
</html>